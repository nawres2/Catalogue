<div class="container">
  <!-- INDICATEUR DE TRADUCTION -->
  <div class="translation-indicator" *ngIf="isTranslating">
    <span class="spinner"></span> Traduction en cours...
  </div>

  <div class="header-with-buttons">
    <h2>{{ getLabel('Gestion des Formations') }}</h2>
    <div class="buttons-container">
      <button class="btn-add" (click)="openModal()">
        <span>+</span> {{ getLabel('Ajouter une formation') }}
      </button>
      <button class="btn-add" (click)="downloadFormations()">
        {{ getLabel('T√©l√©charger Excel') }}
      </button>
    

    </div>
  </div>
<div class="search-container">
  <input
    type="text"
    class="search-input"
    [(ngModel)]="searchTerm"
    placeholder="{{ getLabel('Rechercher une formation...') }}"
  />
</div>



  <!-- TABLEAU FORMATIONS - UTILISE getDisplayedFormations() -->
  <table class="table">
    <thead>
      <tr>
        <th>{{ getLabel('Intitul√©') }}</th>
        <th>{{ getLabel('Axe ') }}</th>
        <th>{{ getLabel('Niveau ') }}</th>
        <th>{{ getLabel('Parcours ') }}</th>
        <th>{{ getLabel('Objectifs ') }}</th>
        <th>{{ getLabel('Comp√©tences ') }}</th>
        <th>{{ getLabel('Actions') }}</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let f of getDisplayedFormations(); let i = index">
        <td>{{ f.intitule }}</td>
<td>{{ translateAxeCustom(f.axe) }}</td>
        <td>{{ f.niveau }}</td>
<td>{{ translateParcoursCustom(f.parcours) }}</td>
      <td>
  <ul class="list-dash-green" *ngIf="f.objectifs.length">
    <li *ngFor="let obj of f.objectifs">
      {{ obj }}
    </li>
  </ul>
</td>



      <td>
  <ul class="list-dash-green" *ngIf="f.competences.length">
    <li *ngFor="let comp of f.competences">
      {{ comp }}
    </li>
  </ul>
</td>




        <td class="actions">
          <button class="icon edit" (click)="openEditModal(f)">‚úèÔ∏è</button>
          <button class="icon delete" (click)="delete(i)">üóëÔ∏è</button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- ================= MODAL EDIT ================= -->
<div class="modal-backdrop" *ngIf="editModalOpen && editFormation">
  <div class="modal">
    <h2>{{ getLabel('Modifier une formation') }}</h2>
    <form (ngSubmit)="updateFormation()" #editForm="ngForm" class="form-grid">

      <!-- COLONNE GAUCHE -->
      <div class="col">
        <label>{{ getLabel('Niveau :') }}</label>
        <select [(ngModel)]="editFormation.niveau" name="edit_niveau" required>
          <option *ngFor="let opt of getNiveauOptions()" [value]="opt.value">
            {{ opt.label }}
          </option>
        </select>

        <label>{{ getLabel('Intitul√© :') }}</label>
        <input type="text" [(ngModel)]="editFormation.intitule" name="edit_intitule" required>

        <label>{{ getLabel('Population :') }}</label>
        <input type="text" [(ngModel)]="editFormation.population" name="edit_population">

        <label>{{ getLabel('Axe :') }}</label>
        <select [(ngModel)]="editFormation.axe" name="edit_axe" required>
          <option *ngFor="let opt of getAxeOptions()" [value]="opt.value">
            {{ opt.label }}
          </option>
        </select>

        <label>{{ getLabel('Interne / Externe :') }}</label>
        <select [(ngModel)]="editFormation.interne_externe" name="edit_interne_externe">
          <option *ngFor="let opt of getInterneExterneOptions()" [value]="opt.value">
            {{ opt.label }}
          </option>
        </select>

        <!-- EXTERNE -->
        <div *ngIf="editFormation.interne_externe === 'externe'">
          <label>{{ getLabel('Prestataire :') }}</label>
          <input type="text" [(ngModel)]="editFormation.prestataire" name="edit_prestataire">
        </div>

        <!-- INTERNE -->
        <div *ngIf="editFormation.interne_externe === 'interne'">
          <label>{{ getLabel('Formateur interne :') }}</label>
          <select [(ngModel)]="editFormation.id_formateur" name="edit_id_formateur">
            <option *ngFor="let f of formateurs" [value]="f.id_user">
              {{ f.nom }} {{ f.prenom }}
            </option>
          </select>
        </div>

        <label>{{ getLabel('Parcours :') }}</label>
        <select [(ngModel)]="editFormation.parcours" name="edit_parcours" required>
          <option *ngFor="let opt of getParcoursOptions()" [value]="opt.value">
            {{ opt.label }}
          </option>
        </select>

        <div *ngIf="editFormation.parcours === 'OnBoarding'" class="form-group">
          <label>{{ getLabel('Pays :') }}</label>
          <div class="checkbox-group">
            <div *ngFor="let p of paysList" class="checkbox-item">
              <input 
                type="checkbox"
                [id]="'pays-' + p.id_pays"
                [value]="p.id_pays"
                [checked]="isPaysSelected(p.id_pays)"
                (change)="togglePays(p.id_pays)"
              />
              <label [for]="'pays-' + p.id_pays">{{ p.nom }}</label>
            </div>
          </div>
        </div>
      </div>

      <!-- COLONNE DROITE -->
      <div class="col">
        <label>{{ getLabel('Dur√©e :') }}</label>
        <div class="row">
          <input type="number" [(ngModel)]="editDureeNumber" name="edit_dureeNumber" min="1" required>
          <select [(ngModel)]="editDureeUnit" name="edit_dureeUnit" required>
            <option *ngFor="let opt of getDureeUnitOptions()" [value]="opt.value">
              {{ opt.label }}
            </option>
          </select>
        </div>

        <label>{{ getLabel('Pr√©requis :') }}</label>
        <textarea [(ngModel)]="editFormation.prerequis" name="edit_prerequis"></textarea>

        <label>{{ getLabel('Objectifs :') }}</label>
        <div *ngFor="let obj of editObjectifsInput; let i = index" class="row">
          <input type="text" [(ngModel)]="editObjectifsInput[i]" [name]="'edit_objectif' + i">
        </div>
        <button type="button" class="btn-add-small" (click)="addEditObjectifInput()">+ {{ getLabel('Ajouter un objectif') }}</button>

        <label>{{ getLabel('Comp√©tences :') }}</label>
        <div *ngFor="let comp of editCompetencesInput; let i = index" class="row">
          <input type="text" [(ngModel)]="editCompetencesInput[i]" [name]="'edit_competence' + i">
        </div>
        <button type="button" class="btn-add-small" (click)="addEditCompetenceInput()">+ {{ getLabel('Ajouter une comp√©tence') }}</button>

        <div class="modal-actions full-width">
          <button type="submit" class="btn-save">{{ getLabel('Mettre √† jour') }}</button>
          <button type="button" class="btn-cancel" (click)="closeEditModal()">{{ getLabel('Annuler') }}</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- ================= MODAL AJOUT ================= -->
<div class="modal-backdrop" *ngIf="modalOpen">
  <div class="modal">
    <h2>{{ getLabel('Ajouter une formation') }}</h2>
    <form (ngSubmit)="saveFormation()" #form="ngForm" class="form-grid">

      <!-- COLONNE GAUCHE -->
      <div class="col">
        <label>{{ getLabel('Niveau :') }}</label>
        <select [(ngModel)]="newFormation.niveau" name="niveau" required>
          <option *ngFor="let opt of getNiveauOptions()" [value]="opt.value">
            {{ opt.label }}
          </option>
        </select>

        <label>{{ getLabel('Intitul√© :') }}</label>
        <input type="text" [(ngModel)]="newFormation.intitule" name="intitule" required>

        <label>{{ getLabel('Population :') }}</label>
        <input type="text" [(ngModel)]="newFormation.population" name="population">

        <label>{{ getLabel('Axe :') }}</label>
        <select [(ngModel)]="newFormation.axe" name="axe" required>
          <option *ngFor="let opt of getAxeOptions()" [value]="opt.value">
            {{ opt.label }}
          </option>
        </select>

        <label>{{ getLabel('Interne / Externe :') }}</label>
        <select [(ngModel)]="newFormation.interne_externe" name="interne_externe">
          <option *ngFor="let opt of getInterneExterneOptions()" [value]="opt.value">
            {{ opt.label }}
          </option>
        </select>

        <!-- EXTERNE -->
        <div *ngIf="newFormation.interne_externe === 'externe'">
          <label>{{ getLabel('Prestataire :') }}</label>
          <input type="text" [(ngModel)]="newFormation.prestataire" name="edit_prestataire">
        </div>

        <!-- INTERNE -->
        <div *ngIf="newFormation.interne_externe === 'interne'">
          <label>{{ getLabel('Formateur interne :') }}</label>
          <select [(ngModel)]="newFormation.id_formateur" name="edit_id_formateur">
            <option *ngFor="let f of formateurs" [value]="f.id_user">
              {{ f.nom }} {{ f.prenom }}
            </option>
          </select>
        </div>
        
        <label>{{ getLabel('Parcours :') }}</label>
        <select [(ngModel)]="newFormation.parcours" name="edit_parcours" required>
          <option *ngFor="let opt of getParcoursOptions()" [value]="opt.value">
            {{ opt.label }}
          </option>
        </select>

        <div *ngIf="newFormation.parcours === 'OnBoarding'" class="form-group">
          <label>{{ getLabel('Pays :') }}</label>
          <div class="checkbox-group">
            <div *ngFor="let p of paysList" class="checkbox-item">
              <input 
                type="checkbox"
                [id]="'new-pays-' + p.id_pays"
                [value]="p.id_pays"
                [checked]="isNewPaysSelected(p.id_pays)"
                (change)="toggleNewPays(p.id_pays)"
              />
              <label [for]="'new-pays-' + p.id_pays">{{ p.nom }}</label>
            </div>
          </div>
        </div>
      </div>

      <!-- COLONNE DROITE -->
      <div class="col">
        <label>{{ getLabel('Dur√©e :') }}</label>
        <div class="row">
          <input type="number" [(ngModel)]="dureeNumber" name="dureeNumber" min="1" placeholder="Ex: 4" required>
          <select [(ngModel)]="dureeUnit" name="dureeUnit" required>
            <option *ngFor="let opt of getDureeUnitOptions()" [value]="opt.value">
              {{ opt.label }}
            </option>
          </select>
        </div>

        <label>{{ getLabel('Pr√©requis :') }}</label>
        <textarea [(ngModel)]="newFormation.prerequis" name="prerequis"></textarea>

        <label>{{ getLabel('Objectifs :') }}</label>
        <div *ngFor="let obj of objectifsInput; let i = index" class="row">
          <input type="text" [(ngModel)]="objectifsInput[i]" [name]="'objectif' + i" placeholder="Saisir un objectif...">
        </div>
        <button type="button" class="btn-add-small" (click)="addObjectifInput()">+ {{ getLabel('Ajouter un objectif') }}</button>

        <label>{{ getLabel('Comp√©tences :') }}</label>
        <div *ngFor="let comp of competencesInput; let i = index" class="row">
          <input type="text" [(ngModel)]="competencesInput[i]" [name]="'competence' + i" placeholder="Saisir une comp√©tence...">
        </div>
        <button type="button" class="btn-add-small" (click)="addCompetenceInput()">+ {{ getLabel('Ajouter une comp√©tence') }}</button>

        <div class="modal-actions full-width">
          <button type="submit" class="btn-save">{{ getLabel('Enregistrer') }}</button>
          <button type="button" class="btn-cancel" (click)="closeModal()">{{ getLabel('Annuler') }}</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- ================= MODAL GUIDE ================= -->
<!-- ================= MODAL GUIDE ADMIN ================= -->
<div class="modal-backdrop guide-overlay" *ngIf="welcomeModalOpen">
  <div class="modal guide-modal-clean">

    <!-- HEADER -->
    <div class="guide-header-clean">
      <h2>{{ getLabel('Guide d\'utilisation') }}</h2>
    </div>

    <!-- PROGRESS -->
    <div class="progress-clean">
      <div
        class="progress-fill"
        [style.width.%]="(currentGuideStep / totalGuideSteps) * 100">
      </div>
    </div>

    <!-- CONTENT -->
    <div class="guide-content-clean">

      <!-- ========== STEP 1 : Bienvenue ========== -->
      <div *ngIf="currentGuideStep === 1" class="step-clean">
        <h3>{{ getLabel('Bienvenue') }}</h3>
        <p>
          {{ getLabel('Cette interface vous permet de g√©rer les formations selon votre r√¥le et leur √©tat de validation.') }}
        </p>
        
        <div class="step-info-bar">
          <span class="icon">üí°</span>
          <span class="text">{{ getLabel('Astuce : Les permissions varient selon votre r√¥le (Admin ou Formateur)') }}</span>
        </div>
      </div>

      <!-- ========== STEP 2 : R√¥les ========== -->
      <div *ngIf="currentGuideStep === 2" class="step-clean">
        <h3>{{ getLabel('Votre r√¥le et permissions') }}</h3>
        
        <!-- ADMIN -->
        <div *ngIf="userRole === 'admin'" class="role-card-clean admin">
          <div class="role-header">
            <span class="role-icon">üëë</span>
            <h4>{{ getLabel('Administrateur') }}</h4>
          </div>
          <ul class="role-permissions">
            <li>‚úì {{ getLabel('Cr√©er, modifier et supprimer toutes les formations') }}</li>
            <li>‚úì {{ getLabel('Valider les formations propos√©es par les formateurs') }}</li>
            <li>‚úì {{ getLabel('Superviser la coh√©rence p√©dagogique') }}</li>
            <li>‚úì {{ getLabel('Acc√®s complet √† toutes les fonctionnalit√©s') }}</li>
          </ul>
        </div>

        <!-- FORMATEUR -->
        <div *ngIf="userRole === 'formateur'" class="role-card-clean formateur">
          <div class="role-header">
            <span class="role-icon">üë®‚Äçüè´</span>
            <h4>{{ getLabel('Formateur') }}</h4>
          </div>
          <ul class="role-permissions">
            <li>‚úì {{ getLabel('Cr√©er une formation') }}</li>
            <li>‚úì {{ getLabel('Modifier ou supprimer une formation') }}</li>
            <li>‚úì {{ getLabel('Uniquement si son statut est ¬´ en attente ¬ª') }}</li>
            <li>‚ö†Ô∏è {{ getLabel('Les formations valid√©es ne peuvent plus √™tre modifi√©es') }}</li>
          </ul>
        </div>
        
        <div class="step-info-bar">
          <span class="icon">üîê</span>
          <span class="text">{{ getLabel('Les permissions sont d√©finies pour garantir la qualit√© des formations') }}</span>
        </div>
      </div>

      <!-- ========== STEP 3 : Bonnes pratiques ========== -->
      <div *ngIf="currentGuideStep === 3" class="step-clean">
        <h3>{{ getLabel('Bonnes pratiques') }}</h3>
        
        <div class="practices-grid">
          <div class="practice-card">
            <div class="practice-icon">üéØ</div>
            <div class="practice-content">
              <h4>{{ getLabel('Objectifs clairs') }}</h4>
              <p>{{ getLabel('D√©finissez des objectifs p√©dagogiques pr√©cis et mesurables') }}</p>
            </div>
          </div>
          
          <div class="practice-card">
            <div class="practice-icon">üìä</div>
            <div class="practice-content">
              <h4>{{ getLabel('Comp√©tences associ√©es') }}</h4>
              <p>{{ getLabel('Associez des comp√©tences mesurables') }}</p>
            </div>
          </div>
          
          <div class="practice-card">
            <div class="practice-icon">‚úÖ</div>
            <div class="practice-content">
              <h4>{{ getLabel('V√©rification') }}</h4>
              <p>{{ getLabel('V√©rifiez les informations avant validation') }}</p>
            </div>
          </div>
          
          <div class="practice-card">
            <div class="practice-icon">üìù</div>
            <div class="practice-content">
              <h4>{{ getLabel('Documentation compl√®te') }}</h4>
              <p>{{ getLabel('Renseignez tous les champs pour une formation de qualit√©') }}</p>
            </div>
          </div>
        </div>
        
        <div class="step-info-bar">
          <span class="icon">üí°</span>
          <span class="text">{{ getLabel('Une formation bien structur√©e facilite l\'apprentissage des participants') }}</span>
        </div>
      </div>

    </div>

    <!-- ACTIONS / NAVIGATION -->
    <div class="guide-footer-clean">
      <button
        class="btn-secondary"
        (click)="previousStep()"
        [disabled]="currentGuideStep === 1">
        {{ getLabel('Pr√©c√©dent') }}
      </button>

      <button
        class="btn-primary"
        *ngIf="currentGuideStep < totalGuideSteps"
        (click)="nextStep()">
        {{ getLabel('Suivant') }}
      </button>

      <button
        class="btn-primary"
        *ngIf="currentGuideStep === totalGuideSteps"
        (click)="closeWelcomeModal()">
        {{ getLabel('Commencer') }}
      </button>
    </div>

  </div>
</div>

<button
  class="help-fab"
  (click)="openGuide()"
  [title]="getLabel('Aide')">
  ?
</button>
