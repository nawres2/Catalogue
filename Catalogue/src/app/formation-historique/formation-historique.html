<div class="container">
  <!-- INDICATEUR DE TRADUCTION -->
  <div class="translation-indicator" *ngIf="isTranslating">
    <span class="spinner"></span> {{ getLabel('Traduction en cours...') }}
  </div>

  <div class="header">
    <h2>{{ getLabel('Historique des formations') }}</h2>
    <div class="filters">
      <button 
        [class.active]="selectedEtat === 'en_attente'" 
        (click)="changeEtat('en_attente')">
        {{ getLabel('En attente') }}
      </button>
      <button 
        [class.active]="selectedEtat === 'validee'" 
        (click)="changeEtat('validee')">
        {{ getLabel('Valid√©es') }}
      </button>
      <button 
        [class.active]="selectedEtat === 'refusee'" 
        (click)="changeEtat('refusee')">
        {{ getLabel('Refus√©es') }}
      </button>
    </div>
  </div>

  <div *ngIf="!loading && formations.length === 0" class="no-data">
    {{ getLabel('Aucune formation trouv√©e') }}
  </div>

  <div class="table-wrapper" *ngIf="!loading && formations.length > 0">
    <table class="table">
      <thead>
        <tr>
          <th>{{ getLabel('Intitul√©') }}</th>
          <th>{{ getLabel('Axe') }}</th>
          <th>{{ getLabel('Niveau') }}</th>
          <th>{{ getLabel('Population') }}</th>
          <th>{{ getLabel('Type') }}</th>
          <th>{{ getLabel('√âtat') }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let f of getDisplayedFormations(); trackBy: trackFormation" (click)="openDetailModal(f)">
          <td>{{ f.intitule }}</td>
          <td>{{ f.axe }}</td>
          <td><span class="badge">{{ f.niveau }}</span></td>
          <td>{{ f.population || getLabel('Non sp√©cifi√©') }}</td>
          <td>{{ f.interne_externe || getLabel('Non d√©fini') }}</td>
          <td>
            <span class="status-badge" [ngClass]="f.etat">{{ f.etat }}</span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Detail Modal -->
<div *ngIf="detailModalOpen && getDisplayedSelectedFormation()" class="modal-backdrop" (click)="closeDetailModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-header-content">
        <h2>{{ getLabel('D√©tails de la formation') }}</h2>
        <span class="status-badge" [ngClass]="getDisplayedSelectedFormation()?.etat">
          {{ getDisplayedSelectedFormation()?.etat }}
        </span>
      </div>
      <button (click)="closeDetailModal()">‚úï</button>
    </div>

    <div class="modal-content">
      <div class="info-section">
        <h3>{{ getLabel('Informations g√©n√©rales') }}</h3>
        <div class="info-grid">
          <div class="info-item">
            <strong>{{ getLabel('Intitul√©') }}</strong>
            <span>{{ getDisplayedSelectedFormation()?.intitule }}</span>
          </div>
          <div class="info-item">
            <strong>{{ getLabel('Axe') }}</strong>
            <span>{{ getDisplayedSelectedFormation()?.axe }}</span>
          </div>
          <div class="info-item">
            <strong>{{ getLabel('Niveau') }}</strong>
            <span class="badge">{{ getDisplayedSelectedFormation()?.niveau }}</span>
          </div>
          <div class="info-item">
            <strong>{{ getLabel('Population') }}</strong>
            <span>{{ getDisplayedSelectedFormation()?.population || getLabel('Non sp√©cifi√©') }}</span>
          </div>
          
          <div class="info-item" *ngIf="getDisplayedSelectedFormation()?.duree">
            <strong>{{ getLabel('Dur√©e') }}</strong>
            <span>{{ getDisplayedSelectedFormation()?.duree }}</span>
          </div>
        </div>
      </div>

      <div class="info-section" *ngIf="getDisplayedSelectedFormation()?.description">
        <h3>{{ getLabel('Description') }}</h3>
        <p>{{ getDisplayedSelectedFormation()?.description }}</p>
      </div>

      <div class="info-section" *ngIf="getDisplayedSelectedFormation()?.objectifs?.length">
        <h3>{{ getLabel('Objectifs p√©dagogiques') }}</h3>
        <ul>
          <li *ngFor="let o of getDisplayedSelectedFormation()?.objectifs">{{ o }}</li>
        </ul>
      </div>

      <div class="info-section" *ngIf="getDisplayedSelectedFormation()?.competences?.length">
        <h3>{{ getLabel('Comp√©tences vis√©es') }}</h3>
        <ul>
          <li *ngFor="let c of getDisplayedSelectedFormation()?.competences">{{ c }}</li>
        </ul>
      </div>

      <div class="info-section" *ngIf="getDisplayedSelectedFormation()?.prerequis">
        <h3>{{ getLabel('prerequis') }}</h3>
        <p>{{ getDisplayedSelectedFormation()?.prerequis }}</p>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="modal-actions" *ngIf="selectedFormation?.etat !== 'validee'">
      <button class="btn btn-update" (click)="openUpdateModal()">
        {{ getLabel('‚úèÔ∏è Modifier') }}
      </button>
      <button class="btn btn-delete" (click)="openDeleteModal()">
        {{ getLabel('üóëÔ∏è Supprimer') }}
      </button>
    </div>
    
    <!-- Message pour formation valid√©e -->
    <div class="modal-info-message" *ngIf="selectedFormation?.etat === 'validee'">
      <span class="info-icon">‚ÑπÔ∏è</span>
      {{ getLabel('Cette formation est valid√©e et ne peut plus √™tre modifi√©e ou supprim√©e.') }}
    </div>
  </div>
</div>

<!-- Update Modal -->
<div *ngIf="updateModalOpen && selectedFormation" class="modal-backdrop" (click)="closeUpdateModal()">
  <div class="update-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ getLabel('Modifier la formation') }}</h2>
      <button (click)="closeUpdateModal()">‚úï</button>
    </div>

    <div class="modal-content" *ngIf="selectedFormation">
      <form (ngSubmit)="confirmUpdate()">
        <div class="row">

          <!-- COLONNE GAUCHE -->
          <div class="col">
            <!-- Niveau -->
            <label>{{ getLabel('Niveau :') }}</label>
            <select [(ngModel)]="selectedFormation!.niveau" name="niveau" required>
              <option value="d√©butant">{{ getLabel('D√©butant') }}</option>
              <option value="interm√©diaire">{{ getLabel('Interm√©diaire') }}</option>
              <option value="avanc√©">{{ getLabel('Avanc√©') }}</option>
              <option value="senior">{{ getLabel('Senior') }}</option>
              <option value="expert">{{ getLabel('Expert') }}</option>
            </select>

           
            <!-- Intitul√© -->
            <label>{{ getLabel('Intitul√© :') }}</label>
            <input type="text" 
                   [ngModel]="getDisplayedEditFormation()?.intitule" 
                   (ngModelChange)="syncTranslatedInput('intitule', $event)" 
                   name="intitule" 
                   required>

            <!-- Population -->
            <label>{{ getLabel('Population :') }}</label>
            <input type="text" 
                   [ngModel]="getDisplayedEditFormation()?.population" 
                   (ngModelChange)="syncTranslatedInput('population', $event)" 
                   name="population">

            <!-- Axe -->
            <label>{{ getLabel('Axe :') }}</label>
            <select [(ngModel)]="selectedFormation!.axe" name="axe" required>
              <option value="Technique">{{ getLabel('Technique') }}</option>
              <option value="Fonctionnelle">{{ getLabel('Fonctionnel') }}</option>
              <option value="M√©tier">{{ getLabel('M√©tier') }}</option>
              <option value="Onboarding">{{ getLabel('Onboarding') }}</option>
              <option value="Solutions">{{ getLabel('Solutions') }}</option>
              <option value="Linguistique">{{ getLabel('Linguistique') }}</option>
              <option value="Transversale">{{ getLabel('Transversale') }}</option>
            </select>

            <!-- Interne / Externe -->
            <label>{{ getLabel('Interne / Externe :') }}</label>
            <select [(ngModel)]="selectedFormation!.interne_externe" name="interne_externe">
              <option value="interne">{{ getLabel('Interne') }}</option>
              <option value="externe">{{ getLabel('Externe') }}</option>
            </select>

            <!-- EXTERNE -->
            <div *ngIf="selectedFormation!.interne_externe === 'externe'">
              <label>{{ getLabel('Prestataire :') }}</label>
              <input type="text" [(ngModel)]="selectedFormation!.prestataire" name="prestataire">
            </div>

            <!-- INTERNE -->
            <div *ngIf="selectedFormation!.interne_externe === 'interne'">
              <label>{{ getLabel('Formateur interne :') }}</label>
              <select [(ngModel)]="selectedFormation!.id_formateur" name="id_formateur">
                <option value="" disabled selected>{{ getLabel('S√©lectionnez un formateur') }}</option>
                <option *ngFor="let f of formateurs" [value]="f.id_user">
                  {{ f.nom }} {{ f.prenom }}
                </option>
              </select>
            </div>

            <!-- Parcours -->
            <label>{{ getLabel('Parcours :') }}</label>
            <select [(ngModel)]="selectedFormation!.parcours" name="parcours" required>
              <option value="">{{ getLabel('S√©lectionnez...') }}</option>
              <option value="Milles">Miles</option>
              <option value="Cassiope">Cassiopae</option>
              <option value="E-flo">E-flo</option>
              <option value="EKIP">EKIP</option>
              <option value="OnBoarding">OnBoarding</option>
            </select>

            <!-- Pays (multi-select for OnBoarding) -->
            <div *ngIf="selectedFormation!.parcours === 'OnBoarding'" class="form-group">
              <label>{{ getLabel('Pays :') }}</label>
              <div class="checkbox-group">
                <div *ngFor="let p of paysList" class="checkbox-item">
                  <input
                    type="checkbox"
                    [id]="'pays-' + p.id_pays"
                    [value]="p.id_pays"
                    [checked]="isPaysSelected(p.id_pays)"
                    (change)="togglePays(p.id_pays)"
                  />
                  <label [for]="'pays-' + p.id_pays">{{ p.nom }}</label>
                </div>
              </div>
            </div>
          </div>

          <!-- COLONNE DROITE -->
          <div class="col">
            <!-- Dur√©e -->
            <label>{{ getLabel('Dur√©e :') }}</label>
            <div class="row">
              <input type="number" [(ngModel)]="editDureeNumber" name="dureeNumber" min="1" required>
              <select [(ngModel)]="editDureeUnit" name="dureeUnit" required>
                <option value="jours">{{ getLabel('Jours') }}</option>
                <option value="heures">{{ getLabel('Heures') }}</option>
              </select>
            </div>

            <!-- Pr√©requis -->
            <label>{{ getLabel('Pr√©requis :') }}</label>
            <textarea 
              [ngModel]="getDisplayedEditFormation()?.prerequis" 
              (ngModelChange)="syncTranslatedInput('prerequis', $event)" 
              name="prerequis"></textarea>

            <!-- Objectifs -->
            <label>{{ getLabel('Objectifs :') }}</label>
            <div *ngFor="let obj of getDisplayedObjectifsInput(); let i = index" class="row">
              <input type="text" 
                     [ngModel]="obj" 
                     (ngModelChange)="syncObjectifInput(i, $event)" 
                     [name]="'objectif' + i">
            </div>
            <button type="button" class="btn-add-small" (click)="addEditObjectifInput()">
              {{ getLabel('+ Ajouter un objectif') }}
            </button>

            <!-- Comp√©tences -->
            <label>{{ getLabel('Comp√©tences :') }}</label>
            <div *ngFor="let comp of getDisplayedCompetencesInput(); let i = index" class="row">
              <input type="text" 
                     [ngModel]="comp" 
                     (ngModelChange)="syncCompetenceInput(i, $event)" 
                     [name]="'competence' + i">
            </div>
            <button type="button" class="btn-add-small" (click)="addEditCompetenceInput()">
              {{ getLabel('+ Ajouter une comp√©tence') }}
            </button>

            <!-- Actions -->
            <div class="modal-actions full-width">
              <button type="submit" class="btn-save">{{ getLabel('Mettre √† jour') }}</button>
              <button type="button" class="btn-cancel" (click)="closeUpdateModal()">
                {{ getLabel('Annuler') }}
              </button>
            </div>
          </div>

        </div>
      </form>
    </div>

  </div>
</div>

<!-- Delete Confirmation Modal -->
<div *ngIf="deleteModalOpen" class="modal-backdrop" (click)="closeDeleteModal()">
  <div class="confirm-modal" (click)="$event.stopPropagation()">
    <div class="confirm-modal-header">
      <span class="confirm-icon">‚ö†Ô∏è</span>
      <h3>{{ getLabel('Confirmer la suppression') }}</h3>
    </div>
    <div class="confirm-modal-body">
      {{ getLabel('√ätes-vous s√ªr de vouloir supprimer cette formation ? Cette action est irr√©versible.') }}
    </div>
    <div class="confirm-modal-actions">
      <button class="btn btn-cancel" (click)="closeDeleteModal()">
        {{ getLabel('Annuler') }}
      </button>
      <button class="btn btn-confirm" (click)="confirmDelete()">
        {{ getLabel('Supprimer') }}
      </button>
    </div>
  </div>
</div>